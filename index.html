<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ABW‑Style Free‑Flow Timeline (15,000 BCE → 2025)</title>
<style>
  :root{
    --bg:#0b0f14;
    --panel:#0f1623;
    --text:#e6eaf2;
    --muted:#9aa4b2;
    --yellow:#f6e05e;   /* modifiable */
    --pink:#ff6ea8;     /* changed */
    --line:rgba(255,255,255,.10);
    --btn:rgba(255,255,255,.06);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--text);}
  header{
    position:sticky;top:0;z-index:10;
    background:rgba(11,15,20,.92);
    backdrop-filter: blur(10px);
    border-bottom:1px solid var(--line);
    padding:14px 16px 10px;
  }
  h1{margin:0;font-size:18px;letter-spacing:.2px}
  .sub{margin-top:6px;color:var(--muted);font-size:13px;line-height:1.35}
  .wrap{max-width:980px;margin:0 auto;padding:14px 16px 24px}
  .toprow{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}
  .pill{
    padding:6px 10px;border-radius:999px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.04);
    color:var(--text);font-size:13px;
  }
  .btn{
    border-radius:10px;
    border:1px solid var(--line);
    background:var(--btn);
    color:var(--text);
    padding:9px 11px;
    font-size:13px;
    cursor:pointer;
  }
  .btn:hover{background:rgba(255,255,255,.09)}
  .grid{display:grid;gap:14px}
  @media(min-width:960px){ .grid{grid-template-columns:1.2fr .8fr; align-items:start;} }
  .card{
    border:1px solid var(--line);
    background:rgba(15,22,35,.85);
    border-radius:14px;
    padding:12px;
  }
  .card h2{margin:0 0 8px;font-size:15px}
  .legend{display:flex;gap:10px;flex-wrap:wrap;color:var(--muted);font-size:12px}
  .swatch{display:inline-flex;align-items:center;gap:8px}
  .dot{width:10px;height:10px;border-radius:3px}
  .dot.yellow{background:var(--yellow)}
  .dot.pink{background:var(--pink)}
  ul{margin:0;padding-left:18px}
  li{margin:10px 0 12px}
  .eventTitle{
    font-weight:800;
    letter-spacing:.1px;
    text-decoration:none;
    cursor:pointer;
  }
  .eventTitle.yellow{color:var(--yellow)}
  .eventTitle.pink{color:var(--pink)}
  .eventMeta{color:var(--muted);font-size:12px;margin-top:4px;line-height:1.35}
  .hr{height:1px;background:var(--line);margin:10px 0}
  .stateRow{display:grid;gap:8px;margin-top:8px}
  .bar{height:8px;border-radius:999px;background:rgba(255,255,255,.08);overflow:hidden;border:1px solid rgba(255,255,255,.10)}
  .fill{height:100%}
  .k{color:var(--muted);font-size:12px;display:flex;justify-content:space-between;gap:10px}
  .note{color:var(--muted);font-size:12px;line-height:1.35}

  /* Modal */
  .modalBack{
    position:fixed;inset:0;background:rgba(0,0,0,.55);
    display:none;align-items:flex-end;justify-content:center;
    padding:18px;z-index:100;
  }
  .modal{
    width:min(820px,100%);
    background:rgba(15,22,35,.98);
    border:1px solid var(--line);
    border-radius:16px;
    overflow:hidden;
  }
  .modalHead{padding:12px 14px;border-bottom:1px solid var(--line)}
  .modalHead .t{font-weight:900}
  .modalHead .m{color:var(--muted);font-size:12px;margin-top:4px;line-height:1.35}
  .modalBody{padding:12px 14px;display:grid;gap:10px}
  .choice{
    width:100%;text-align:left;
    border-radius:12px;padding:12px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(255,255,255,.05);
    color:var(--text);cursor:pointer;
  }
  .choice:hover{background:rgba(255,255,255,.08)}
  .delta{float:right;font-weight:900}
  .delta.pos{color:#6ee7b7}
  .delta.neg{color:#fb7185}
  .delta.neu{color:var(--muted)}
  .modalFoot{padding:12px 14px;border-top:1px solid var(--line);display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
</style>
</head>
<body>
<header>
  <h1>ABW‑Style Free‑Flow Timeline (15,000 BCE → 2025)</h1>
  <div class="sub">
    Dates you can change are in <span style="color:var(--yellow);font-weight:800">yellow</span>.
    Dates you changed are in <span style="color:var(--pink);font-weight:800">pink</span>.
    Tap any event to rewrite history — the future will regenerate.
  </div>
  <div class="toprow">
    <span class="pill">Your current karma: <strong id="karma">0</strong></span>
    <button class="btn" onclick="showUchronies()">See list of Uchronies</button>
    <button class="btn" onclick="startOver()">It didn’t go well, I’d like to start over…</button>
    <button class="btn" onclick="exportSave()">Export save</button>
  </div>
</header>

<div class="wrap grid">
  <section class="card">
    <h2>Timeline</h2>
    <div class="legend">
      <span class="swatch"><span class="dot yellow"></span>modifiable</span>
      <span class="swatch"><span class="dot pink"></span>changed</span>
    </div>
    <div class="hr"></div>
    <ul id="timeline"></ul>
    <div class="hr"></div>
    <div class="note">This is a “chain of history” generator: no steps, no levels. Edit the past and the future rewrites itself.</div>
  </section>

  <aside class="card">
    <h2>World State</h2>
    <div class="note">Your choices shift these stats. The generator uses them to decide what kinds of events appear next.</div>
    <div class="stateRow" id="state"></div>
    <div class="hr"></div>
    <h2>Endgame card (2025)</h2>
    <div class="note" id="endcard">Reach 2025 to see the world summary.</div>
  </aside>
</div>

<div class="modalBack" id="modalBack" onclick="if(event.target.id==='modalBack') closeModal()">
  <div class="modal">
    <div class="modalHead">
      <div class="t" id="modalTitle">Event</div>
      <div class="m" id="modalDesc">Choose a modification.</div>
    </div>
    <div class="modalBody" id="modalChoices"></div>
    <div class="modalFoot">
      <button class="btn" onclick="closeModal()">Close</button>
      <div class="note">Choosing an option will regenerate everything after this date.</div>
    </div>
  </div>
</div>

<script>
/* -------------------- PRNG -------------------- */
function xmur3(str){for(var i=0,h=1779033703^str.length;i<str.length;i++){h=Math.imul(h^str.charCodeAt(i),3432918353);h=h<<13|h>>>19;}return function(){h=Math.imul(h^h>>>16,2246822507);h=Math.imul(h^h>>>13,3266489909);return (h^h>>>16)>>>0;}}
function sfc32(a,b,c,d){return function(){a|=0;b|=0;c|=0;d|=0;var t=(a+b|0)+d|0;d=d+1|0;a=b^b>>>9;b=c+(c<<3)|0;c=(c<<21|c>>>11);c=c+t|0;return (t>>>0)/4294967296;}}
function makeRng(seedStr){const seed=xmur3(seedStr);return sfc32(seed(),seed(),seed(),seed());}
const clamp=(x,min,max)=>Math.max(min,Math.min(max,x));

function formatYear(y){ return y<0 ? `${Math.abs(y)} BCE` : `${y} CE`; }
function escapeHtml(str){
  return String(str).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

/* -------------------- Persistence -------------------- */
function loadUchronies(){ try{const raw=localStorage.getItem("abw_uchronies_v5");return raw?JSON.parse(raw):[];}catch{return [];} }
function saveUchronies(list){ localStorage.setItem("abw_uchronies_v5", JSON.stringify(list)); }

function defaultGame(){
  return {
    karma:0,
    stats:{ peace:50, tech:28, health:35, climate:55, freedom:30, inequality:65 },
    posDecisions:[],   // {pos, choiceIndex}
    chain:[],
    uchronies: loadUchronies()
  };
}
function saveGame(){
  localStorage.setItem("abw_freeflow_v5", JSON.stringify({
    karma:game.karma, stats:game.stats, posDecisions:game.posDecisions||[], chain:game.chain||[]
  }));
}
function loadGame(){
  try{
    const raw=localStorage.getItem("abw_freeflow_v5");
    if(!raw) return null;
    const g=JSON.parse(raw);
    if(!g.stats || typeof g.karma!=="number") return null;
    return { karma:g.karma, stats:g.stats, posDecisions:g.posDecisions||[], chain:g.chain||[], uchronies: loadUchronies() };
  }catch{ return null; }
}

let game = loadGame() || defaultGame();

/* -------------------- Templates (real + invented) -------------------- */
function opt(text, karma, delta){ return {text, karma, delta}; }
function tpl(era, title, desc, options, weight){ return {era, title, desc, options, weight, kind:"real"}; }
function dyn(era, titleFn, desc, options, weight){ return {era, titleFn, desc, options, weight, kind:"invented"}; }

let rng = makeRng(seedString());
function seedString(){
  const base="abw_freeflow_15000bce_v1";
  const d=(game.posDecisions||[]).map(x=>`${x.pos}:${x.choiceIndex}`).join("|");
  return base+"|"+d;
}
function pick(arr){ return arr[Math.floor(rng()*arr.length)]; }

const templates = [
  /* 15,000–10,000 BCE: Late Upper Paleolithic / deglaciation */
  tpl([-15000,-10500], "Warming world reshapes migration routes",
    "As ice retreats, people follow herds and coastlines. Cooperation and knowledge transfer decide survival.",
    [
      opt("Share navigation and foraging knowledge between groups.", +5, {peace:+6, health:+3, inequality:-3}),
      opt("Raid neighbors as resources fluctuate.", -4, {peace:-8, health:-2, inequality:+4}),
      opt("Create seasonal councils to settle disputes.", +3, {peace:+5, freedom:+2})
    ],
    {w:{peace:1.0}}
  ),
  tpl([-13000,-9000], "Sedentary settlements appear",
    "Staying put enables storage and specialization—also land disputes and new hierarchies.",
    [
      opt("Rotate leadership; keep stores accountable.", +5, {freedom:+5, inequality:-5, peace:+2}),
      opt("Let store-keepers become permanent elites.", -4, {inequality:+10, freedom:-3}),
      opt("Federate villages to manage water and trade.", +4, {peace:+4, tech:+2})
    ],
    {w:{inequality:-0.9, freedom:0.7}}
  ),

  /* 10,000–3,500 BCE: Neolithic to early cities */
  tpl([-10500,-7000], "Agriculture takes off (domestication wave)",
    "Farming boosts population but risks malnutrition and inequality without safety nets.",
    [
      opt("Mixed farming + commons rules + grain reserves.", +5, {health:+4, inequality:-6, tech:+2}),
      opt("Monoculture + landlord control.", -5, {inequality:+10, health:-2}),
      opt("Slow adoption: farming + foraging resilience.", +3, {health:+3, climate:+1, tech:+1})
    ],
    {w:{inequality:-1.1, health:0.7}}
  ),
  tpl([-7000,-3500], "Writing and accounting emerge",
    "Records can broaden trade and law—or centralize power behind scribes.",
    [
      opt("Open literacy training; standardize fair contracts.", +5, {freedom:+7, tech:+5, inequality:-3}),
      opt("Restrict literacy to temples/palaces.", -3, {freedom:-6, inequality:+5}),
      opt("Use writing for medicine and engineering manuals.", +4, {tech:+6, health:+2})
    ],
    {w:{freedom:1.0, tech:0.8}}
  ),
  tpl([-5000,-1000], "Bronze Age trade networks expand",
    "Long-distance trade spreads ideas and disease; institutions decide which dominates.",
    [
      opt("Treaties + shared standards + quarantine ports.", +5, {peace:+5, health:+3, tech:+2}),
      opt("Piracy and tribute empires dominate routes.", -4, {peace:-6, inequality:+4}),
      opt("Loose networks: high trade, low enforcement.", 0, {tech:+2, health:-1})
    ],
    {w:{peace:0.8, health:0.7}}
  ),

  /* 1,200–400 BCE */
  tpl([-1200,-400], "Ironworking spreads widely",
    "Cheaper tools raise yields; cheaper weapons raise wars. Policy decides.",
    [
      opt("Prioritize tools, farming, and public works.", +4, {tech:+6, health:+2, peace:+1}),
      opt("Arms race between kingdoms.", -4, {peace:-8, inequality:+2}),
      opt("Weapon limits + regional diplomacy.", +3, {peace:+6, freedom:+1})
    ],
    {w:{peace:0.9, tech:0.7}}
  ),

  /* 800 BCE – 200 CE */
  tpl([-800,200], "Classical civic models compete",
    "Ideas about law, citizenship, and equality spread—either as rights or as propaganda.",
    [
      opt("Civic education + rule of law + expanded rights.", +5, {freedom:+10, peace:+2, inequality:-4}),
      opt("Entrench rigid class systems.", -3, {inequality:+8, freedom:-4}),
      opt("Rights locally, conquest externally.", +1, {freedom:+2, peace:-2})
    ],
    {w:{freedom:1.2, inequality:-0.7}}
  ),

  /* 200–700 CE */
  tpl([200,700], "A major empire reforms or fragments",
    "Administrative reforms can stabilize trade and public health—or collapse into smaller rival states.",
    [
      opt("Tax reform + roads + sanitation + grain policy.", +5, {peace:+5, health:+6, tech:+2}),
      opt("Overextract provinces; elite luxury politics.", -4, {peace:-6, inequality:+6}),
      opt("Decentralize into resilient city federations.", +3, {peace:+4, freedom:+2})
    ],
    {w:{health:0.9, peace:0.8}}
  ),

  /* 700–1200 */
  tpl([700,1200], "A pan‑regional legal charter spreads",
    "A shared legal framework can reduce feuds—or become a tool for control.",
    [
      opt("Independent courts + rights protections.", +5, {peace:+7, freedom:+6, inequality:-3}),
      opt("Law is written to protect nobles only.", -3, {inequality:+6, freedom:-3}),
      opt("Religious courts only; weak secular law.", -2, {freedom:-2, peace:-2})
    ],
    {w:{freedom:1.0, peace:0.8}}
  ),

  /* 1200–1495 */
  tpl([1200,1495], "The Black Death shocks Eurasia",
    "A pandemic collides with dense trade routes. Public trust and labor bargaining shift for centuries.",
    [
      opt("Quarantine + clean water + early public health offices.", +5, {health:+10, peace:+2}),
      opt("Scapegoating and censorship.", -5, {health:-8, freedom:-4, peace:-3}),
      opt("Local mitigation only; no coordination.", -2, {health:-4})
    ],
    {w:{health:1.2}}
  ),

  /* 1400–1700 */
  tpl([1400,1700], "Printing press goes mainstream",
    "Information can empower citizens—or be throttled by gatekeepers.",
    [
      opt("Protect literacy and independent presses.", +4, {freedom:+10, inequality:-4}),
      opt("Strict licensing and censorship.", -2, {freedom:-6}),
      opt("Schools first, then open printing.", +3, {freedom:+6, tech:+3})
    ],
    {w:{freedom:1.0}}
  ),

  /* 1492–1800 */
  tpl([1492,1800], "Transoceanic contact reshapes continents",
    "Contact can be exchange—or extraction with massive disease shock.",
    [
      opt("Rights protections + fair treaties + disease controls.", +5, {health:+6, inequality:-6, freedom:+4}),
      opt("Extraction-first conquest.", -5, {inequality:+10, freedom:-6, peace:-4}),
      opt("Slow regulated exchange; reduce shock.", +3, {health:+4, peace:+2})
    ],
    {w:{health:0.8, inequality:-0.8}}
  ),

  /* 1760–1913 */
  tpl([1760,1913], "Industrial Revolution accelerates",
    "Productivity explodes; so do pollution and exploitation unless standards arrive early.",
    [
      opt("Labor rights + early clean-air rules.", +5, {inequality:-6, climate:+6, health:+4, tech:+2}),
      opt("Max output; ignore conditions.", -5, {inequality:+10, health:-4, climate:-6, tech:+3}),
      opt("Slow expansion; urban planning & transit.", +3, {health:+4, climate:+4, tech:-1})
    ],
    {w:{inequality:-1.0, climate:0.8}}
  ),
  tpl([1800,1913], "Abolition accelerates globally",
    "A coordinated end to slavery reshapes economies and human rights norms.",
    [
      opt("Rebuild communities; prosecute traffickers.", +5, {freedom:+10, inequality:-8, peace:+3}),
      opt("Abolish on paper; loopholes persist.", -2, {inequality:+6, freedom:-4}),
      opt("Delay abolition.", -5, {freedom:-8, inequality:+8})
    ],
    {w:{freedom:1.0, inequality:-0.8}}
  ),

  /* 1914–1946 */
  tpl([1914,1945], "The Great War ignites",
    "One assassination becomes a cascade. Systems can absorb shocks… or shatter.",
    [
      opt("De-escalation treaties + arbitration.", +5, {peace:+12, freedom:+2}),
      opt("Alliances fire automatically.", 0, {peace:-6, inequality:+2}),
      opt("Escalate for a ‘decisive’ outcome.", -5, {peace:-12, health:-4})
    ],
    {w:{peace:1.2}}
  ),
  tpl([1918,1921], "A global influenza pandemic spreads",
    "Public health capacity determines mortality and institutional trust.",
    [
      opt("Transparent reporting + clinics + ventilation standards.", +5, {health:+12, freedom:+2}),
      opt("Censor and downplay risks.", -5, {health:-10, freedom:-3}),
      opt("Local measures only.", -3, {health:-6})
    ],
    {w:{health:1.2}}
  ),
  tpl([1939,1946], "World War II escalates",
    "A global crisis of authoritarianism. Outcome shapes the century’s moral baseline.",
    [
      opt("Accelerate defeat + reconciliation + trials.", +5, {peace:+10, freedom:+6, inequality:-2}),
      opt("Let history play out.", 0, {peace:-2}),
      opt("Enable authoritarian victory.", -10, {freedom:-20, peace:-15, inequality:+10})
    ],
    {w:{freedom:1.2, peace:1.0}}
  ),

  /* 1945–2000 */
  tpl([1945,1999], "Creation of the United Nations",
    "A global forum can be symbolic—or capable of coordinated action.",
    [
      opt("Empower peacekeeping + health + development finance.", +5, {peace:+10, health:+4, inequality:-3}),
      opt("Keep it weak; sovereignty first.", -2, {peace:-4, inequality:+2}),
      opt("Regional unions over global body.", +2, {peace:+3})
    ],
    {w:{peace:1.0}}
  ),
  tpl([1950,1991], "Cold War flashpoint",
    "Proxy conflicts flare when trust is low and inequality high.",
    [
      opt("De-escalate via inspections and exchange.", +4, {peace:+8, freedom:+2}),
      opt("Arms race and aggressive posturing.", -4, {peace:-8, climate:-2}),
      opt("Back-channel détente; reduce stockpiles.", +5, {peace:+12})
    ],
    {w:{peace:1.2}}
  ),
  tpl([1960,1999], "The internet emerges",
    "The default architecture decides privacy, power, and access.",
    [
      opt("Net neutrality + encryption + universal access.", +5, {freedom:+10, tech:+8, inequality:-3}),
      opt("Corporate-gated model with weak privacy.", -3, {freedom:-5, inequality:+5, tech:+4}),
      opt("Public utility model (slow, stable, regulated).", +3, {freedom:+4, inequality:-2, tech:+2})
    ],
    {w:{freedom:1.0, tech:0.8}}
  ),

  /* 2000–2025 */
  tpl([2000,2025], "A climate decade begins",
    "Policy choices decide disaster frequency and migration pressure.",
    [
      opt("Rapid renewables + carbon pricing + adaptation funds.", +5, {climate:+12, health:+3, peace:+2}),
      opt("Delay action for short-term politics.", -5, {climate:-12, peace:-2, health:-2}),
      opt("Tech-only fix (geoengineering focus).", +1, {tech:+5, climate:+2, peace:-1})
    ],
    {w:{climate:1.2}}
  ),
  tpl([2000,2025], "Global pandemic response",
    "Preparedness and solidarity determine deaths, variants, and institutional trust.",
    [
      opt("Equitable vaccines + transparency + manufacturing scale-up.", +5, {health:+12, peace:+3, inequality:-3}),
      opt("Vaccine nationalism + misinformation.", -3, {health:-6, peace:-3, inequality:+4}),
      opt("Heavy-handed controls with weak support.", -2, {freedom:-4, inequality:+3, health:+2})
    ],
    {w:{health:1.2, freedom:0.5}}
  ),
  tpl([2005,2025], "AI safety standards arrive",
    "Early guardrails can prevent harms—or a race-to-the-bottom can create backlash.",
    [
      opt("Global audits, safety evals, accountability.", +5, {freedom:+3, tech:+6, inequality:-2}),
      opt("Speed-first deployment; minimal oversight.", -3, {inequality:+4, freedom:-3, tech:+4}),
      opt("Pause high-risk systems; fund public-benefit research.", +4, {freedom:+2, tech:+2})
    ],
    {w:{tech:1.2}}
  ),
  tpl([2010,2025], "Digital democracy reform",
    "Institutions can modernize against manipulation—or stagnate.",
    [
      opt("Secure participation + transparency + civic tools.", +5, {freedom:+12, peace:+2, inequality:-2}),
      opt("Minor tweaks; status quo.", 0, {freedom:+1}),
      opt("Centralize control to ‘prevent chaos’.", -4, {freedom:-10, peace:-2})
    ],
    {w:{freedom:1.2}}
  ),

  /* Invented but plausible procedural events (across all eras) */
  dyn([-15000,2025], () => pick([
      "A breakthrough in {field}",
      "A scandal reshapes {institution}",
      "A treaty redraws {region}",
      "A crisis hits {system}",
      "A movement changes {value}",
      "A new trade network links {region}"
    ]),
    "A fresh curveball: new actors, new tools, and unintended consequences.",
    [
      opt("Steer it toward equity and rights.", +4, {freedom:+6, inequality:-4, peace:+2}),
      opt("Let power concentrate around elites.", -3, {inequality:+6, freedom:-3}),
      opt("Prioritize stability over reform.", +1, {peace:+3, freedom:-1})
    ],
    {w:{freedom:0.7, inequality:-0.5}}
  ),
  dyn([-15000,2025], () => pick([
      "A leap in {field} spreads faster than institutions",
      "A climate anomaly reshapes {region}",
      "A public health campaign transforms {system}",
      "An unexpected alliance forms in {region}",
      "A frontier settlement becomes a metropolis in {region}"
    ]),
    "This event is invented, but generated to match your world state — and it will ripple forward.",
    [
      opt("Build institutions to match the new reality.", +5, {peace:+4, freedom:+3, health:+3, inequality:-2}),
      opt("Exploit it for advantage.", -3, {inequality:+5, peace:-2}),
      opt("Treat it as temporary; do nothing.", -1, {peace:-1})
    ],
    {w:{peace:0.6, health:0.6, climate:0.6}}
  )
];

function fillDynTitle(title){
  const dict = {
    field: pick(["medicine","energy","computing","materials","agriculture","education","transport","vaccines","satellites","batteries","water systems","antibiotics","navigation","metallurgy"]),
    institution: pick(["the press","a council","a central bank","a social network","a parliament","a tech guild","a public health council","a priesthood"]),
    region: pick(["the Levant","Mesopotamia","the Mediterranean","South Asia","the Pacific","the Middle East","Africa","the Americas","the Arctic","Eurasia","global supply chains"]),
    system: pick(["food systems","cities","finance","healthcare","democracy","climate policy","water supplies","information ecosystems","labor markets"]),
    value: pick(["privacy","labor rights","women’s rights","civil rights","open science","anti-corruption","local democracy","religious tolerance","rule of law"])
  };
  return title.replaceAll("{field}",dict.field)
              .replaceAll("{institution}",dict.institution)
              .replaceAll("{region}",dict.region)
              .replaceAll("{system}",dict.system)
              .replaceAll("{value}",dict.value);
}

/* -------------------- Selection & year jumps -------------------- */
function weightForTemplate(t){
  let w=1.0;
  // stat weighting
  if(t.weight && t.weight.w){
    for(const [k,coef] of Object.entries(t.weight.w)){
      const v = game.stats[k] ?? 50;
      const norm = (v-50)/50;
      w *= (1 + coef*norm);
    }
  }
  // bias toward real events (you asked for “as close to ABW as possible”)
  if(t.kind==="real") w *= 1.22;
  else w *= 0.95;
  return Math.max(0.05,w);
}
function chooseTemplate(year){
  const cands = templates.filter(t=> year>=t.era[0] && year<=t.era[1]).map(t=>({...t}));
  const weights = cands.map(weightForTemplate);
  const total = weights.reduce((s,x)=>s+x,0);
  let r = rng()*total;
  for(let i=0;i<cands.length;i++){ r-=weights[i]; if(r<=0) return cands[i]; }
  return cands[cands.length-1];
}

function eraBucket(year){
  if(year < -10500) return "paleo";
  if(year < -3500) return "neolithic";
  if(year < -1200) return "bronze";
  if(year < 200) return "classical";
  if(year < 700) return "late_antique";
  if(year < 1200) return "medieval";
  if(year < 1492) return "late_medieval";
  if(year < 1760) return "early_modern";
  if(year < 1914) return "industrial";
  if(year < 1946) return "world_wars";
  if(year < 2000) return "postwar";
  return "modern";
}
function yearJump(year){
  const e=eraBucket(year);
  if(e==="paleo") return Math.floor(400 + rng()*1200);     // 400–1600
  if(e==="neolithic") return Math.floor(200 + rng()*700);  // 200–900
  if(e==="bronze") return Math.floor(120 + rng()*450);     // 120–570
  if(e==="classical") return Math.floor(60 + rng()*220);   // 60–280
  if(e==="late_antique") return Math.floor(30 + rng()*120);// 30–150
  if(e==="medieval") return Math.floor(20 + rng()*90);     // 20–110
  if(e==="late_medieval") return Math.floor(10 + rng()*60);// 10–70
  if(e==="early_modern") return Math.floor(8 + rng()*50);  // 8–58
  if(e==="industrial") return Math.floor(5 + rng()*25);    // 5–30
  if(e==="world_wars") return Math.floor(1 + rng()*7);     // 1–8
  if(e==="postwar") return Math.floor(2 + rng()*12);       // 2–14
  return Math.floor(1 + rng()*6);                          // 1–7
}

/* -------------------- Apply deltas -------------------- */
function applyStatDelta(delta){
  for(const [k,v] of Object.entries(delta||{})){
    game.stats[k] = clamp((game.stats[k] ?? 50) + v, 0, 100);
  }
}

/* -------------------- Build chain (free-flow) -------------------- */
function hash32(str){
  let h=2166136261;
  for(let i=0;i<str.length;i++){ h^=str.charCodeAt(i); h=Math.imul(h,16777619); }
  return (h>>>0).toString(16).slice(0,8);
}

function rebuild(){
  rng = makeRng(seedString());

  // reset derived state and replay positional decisions
  game.karma = 0;
  game.stats = { peace:50, tech:28, health:35, climate:55, freedom:30, inequality:65 };

  const chain=[];
  let year=-15000;
  let safety=0;
  let ordinal=0;

  while(year <= 2025 && safety++ < 700){
    ordinal++;
    const t = chooseTemplate(year);
    const title = (t.kind==="invented") ? fillDynTitle(t.titleFn()) : t.title;
    const id = `${year}_${hash32(title)}_${ordinal}`;
    const node = { id, year, title, desc:t.desc, options:t.options, chosen:null, kind:t.kind };
    chain.push(node);

    // Apply decision at this position if exists
    const pd=(game.posDecisions||[]).find(x=>x.pos===chain.length-1);
    if(pd){
      node.chosen = pd.choiceIndex;
      const o = node.options[pd.choiceIndex];
      game.karma += o.karma;
      applyStatDelta(o.delta);
    }

    year += yearJump(year);

    // Gentle anchors so iconic eras appear often (still not steps)
    if (year < -10500 && rng() < 0.08) year = -10500;
    if (year < -3500  && rng() < 0.08) year = -3500;
    if (year < -1200  && rng() < 0.07) year = -1200;
    if (year < 0      && rng() < 0.06) year = 0;
    if (year < 476    && rng() < 0.05) year = 476;
    if (year < 1200   && rng() < 0.05) year = 1200;
    if (year < 1492   && rng() < 0.06) year = 1492;
    if (year < 1760   && rng() < 0.05) year = 1760;
    if (year < 1914   && rng() < 0.06) year = 1914;
    if (year < 1939   && rng() < 0.06) year = 1939;
    if (year < 1945   && rng() < 0.06) year = 1945;
    if (year < 2000   && rng() < 0.06) year = 2000;
    if (year < 2020   && rng() < 0.10) year = 2020;
    if (year < 2025   && rng() < 0.12) year = 2025;
  }

  // Ensure the chain ends at 2025 (ABW-style “final card”)
  if(chain.length && chain[chain.length-1].year !== 2025){
    chain.push({
      id:`2025_${hash32("Endgame Card")}_final`,
      year:2025,
      title:"2025 — The World You Shaped",
      desc:"A summary card of your timeline’s direction.",
      options:[
        {text:"(No change — end card)", karma:0, delta:{}}
      ],
      chosen:0,
      kind:"real"
    });
  }

  game.chain = chain;
  saveGame();
  renderAll();
}

/* -------------------- Render -------------------- */
const elKarma=document.getElementById("karma");
const elTimeline=document.getElementById("timeline");
const elState=document.getElementById("state");
const elEnd=document.getElementById("endcard");

const modalBack=document.getElementById("modalBack");
const modalTitle=document.getElementById("modalTitle");
const modalDesc=document.getElementById("modalDesc");
const modalChoices=document.getElementById("modalChoices");

function renderState(){
  const labels=[
    ["peace","Peace"],
    ["tech","Tech"],
    ["health","Health"],
    ["climate","Climate"],
    ["freedom","Freedom"],
    ["inequality","Inequality (lower is better)"]
  ];
  elState.innerHTML="";
  labels.forEach(([k,label])=>{
    const v=game.stats[k] ?? 50;
    const wrap=document.createElement("div");
    wrap.innerHTML = `
      <div class="k"><span>${label}</span><span>${Math.round(v)}/100</span></div>
      <div class="bar"><div class="fill" style="width:${clamp(v,0,100)}%;background:rgba(246,224,94,.9)"></div></div>
    `;
    elState.appendChild(wrap);
  });
}

function endCardText(){
  const s=game.stats;
  const score = (s.peace + s.health + s.climate + s.freedom + s.tech + (100-s.inequality)) / 6;

  const vibe =
    score >= 78 ? "High-trust, high-capacity world with strong institutions." :
    score >= 62 ? "Mostly stable world with tradeoffs and regional cracks." :
    score >= 46 ? "Uneven world: progress exists, but crises are frequent." :
                  "Low-trust world: fragmentation, scarcity politics, and recurring shocks.";

  // a few “headline” style summaries
  const headlines=[];
  if(s.climate >= 65) headlines.push("Climate action is coordinated; disasters are less destabilizing.");
  if(s.climate <= 35) headlines.push("Climate shocks drive migration and political stress.");
  if(s.health >= 65) headlines.push("Public health capacity is strong and trusted.");
  if(s.freedom >= 65) headlines.push("Rights and civic participation are robust.");
  if(s.freedom <= 35) headlines.push("Surveillance and centralized control expand.");
  if(s.inequality <= 40) headlines.push("Inequality is contained; social mobility is higher.");
  if(s.inequality >= 70) headlines.push("Extreme inequality fuels unrest and instability.");
  if(s.tech >= 70) headlines.push("Rapid tech diffusion accelerates productivity and new risks.");
  if(s.peace <= 40) headlines.push("Geopolitical conflict remains a constant background hum.");

  return `<strong>${vibe}</strong><br/><br/>Karma: <strong>${game.karma}</strong><br/>World score: <strong>${Math.round(score)}/100</strong><br/><br/>• ${headlines.slice(0,4).join("<br/>• ")}`;
}

function renderTimeline(){
  elTimeline.innerHTML="";
  (game.chain||[]).forEach((ev, pos)=>{
    const li=document.createElement("li");
    const changed = (ev.chosen!==null && ev.chosen!==undefined && pos < (game.chain.length-1) && ev.options.length>1);
    const cls = changed ? "pink" : "yellow";

    const a=document.createElement("a");
    a.className=`eventTitle ${cls}`;
    a.href="javascript:void(0)";
    a.textContent=`${formatYear(ev.year)} — ${ev.title}`;
    a.onclick=()=>openEvent(pos);

    const meta=document.createElement("div");
    meta.className="eventMeta";
    meta.textContent=ev.desc + (ev.kind==="invented" ? " (procedurally generated)" : "");

    const mod=document.createElement("div");
    mod.className="eventMeta";
    mod.style.marginTop="6px";
    mod.innerHTML = `<span style="opacity:.85">[POSSIBLE MODIFICATION]</span>` + (changed?` · <span style="color:var(--pink);font-weight:800">changed</span>`:"");

    li.appendChild(a); li.appendChild(meta); li.appendChild(mod);
    elTimeline.appendChild(li);
  });
}

function renderAll(){
  elKarma.textContent = game.karma;
  renderState();
  renderTimeline();
  elEnd.innerHTML = endCardText();
}

/* -------------------- Modal interactions -------------------- */
function impactText(delta){
  const parts=[];
  for(const [k,v] of Object.entries(delta||{})){
    const sign=v>0?"+":"";
    parts.push(`${k} ${sign}${v}`);
  }
  return parts.length ? `Effects: ${parts.join(", ")}` : "Effects: none";
}
function openEvent(pos){
  const ev=(game.chain||[])[pos];
  if(!ev) return;

  // End card: no editing
  if(ev.year===2025 && ev.options.length===1){
    modalTitle.textContent = `${formatYear(ev.year)} — ${ev.title}`;
    modalDesc.textContent = "This is the endgame summary card. Change earlier events to rewrite it.";
    modalChoices.innerHTML = "";
    modalBack.style.display="flex";
    return;
  }

  modalTitle.textContent = `${formatYear(ev.year)} — ${ev.title}`;
  modalDesc.textContent = ev.desc + "  Choose what you change:";
  modalChoices.innerHTML="";

  ev.options.forEach((o, choiceIndex)=>{
    const b=document.createElement("button");
    b.className="choice";
    const dcls=o.karma>0?"pos":o.karma<0?"neg":"neu";
    b.innerHTML = `<span class="delta ${dcls}">${o.karma>0?`+${o.karma}`:o.karma}</span>${escapeHtml(o.text)}<div style="margin-top:6px;color:var(--muted);font-size:12px;line-height:1.35">${impactText(o.delta)}</div>`;
    b.onclick = ()=>chooseModification(pos, choiceIndex);
    modalChoices.appendChild(b);
  });

  modalBack.style.display="flex";
}
function closeModal(){ modalBack.style.display="none"; }

function chooseModification(pos, choiceIndex){
  // keep decisions up to pos, overwrite at pos, drop the future (butterfly effect)
  const kept=(game.posDecisions||[]).filter(d=>d.pos<=pos);
  const existing=kept.find(d=>d.pos===pos);
  if(existing) existing.choiceIndex=choiceIndex;
  else kept.push({pos, choiceIndex});
  game.posDecisions = kept.sort((a,b)=>a.pos-b.pos);

  rebuild();
  closeModal();
}

/* -------------------- Uchronies / Controls -------------------- */
function finishAndArchive(){
  const changed=(game.chain||[]).filter(e=>e.options.length>1 && e.chosen!==null).slice(0,6)
    .map(e=>`${formatYear(e.year)}:${e.title}`).join(" | ");
  const summary=changed || "No changes";
  const entry={when:new Date().toISOString().slice(0,10), karma:game.karma, summary};
  const list=loadUchronies(); list.push(entry); saveUchronies(list);
}
function showUchronies(){
  const list=loadUchronies();
  const lines=list.slice().reverse().slice(0,20).map((u,i)=>`${i+1}. ${u.when} — Karma ${u.karma} — ${u.summary}`).join("\n");
  alert(list.length?`Your Uchronies (most recent first):\n\n${lines}`:"No saved uchronies yet. Restart after making changes to save one.");
}
function startOver(){
  if(confirm("Start over? This will archive your current uchrony (if any) and reset the timeline.")){
    finishAndArchive();
    game = defaultGame();
    saveGame();
    rebuild();
    window.scrollTo({top:0,behavior:"smooth"});
  }
}
function exportSave(){
  const data={
    karma: game.karma,
    stats: game.stats,
    decisionsByPosition: game.posDecisions||[],
    timelineSnapshot: (game.chain||[]).map(e=>({year:e.year,title:e.title,chosen:e.chosen,kind:e.kind}))
  };
  const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a"); a.href=url; a.download="abw_15000bce_freeflow_save.json";
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

/* -------------------- Init -------------------- */
(function init(){
  // If chain empty, build. If chain exists, render and ensure endcard is updated.
  if(!game.chain || !game.chain.length){
    rebuild();
  }else{
    // Recompute end card text from current stats/karma (fast render)
    renderAll();
  }
})();
</script>
</body>
</html>
